openapi: 3.0.3
info:
  title: Task Dashboard API (Queue Board)
  version: 1.0.0
  description: |
    PII 모니터링 모듈 관련 PM/개발 개입이 필요한 승인 요청을 일괄 조회하는 **Queue Board** API입니다.

    ---

    ### 아키텍처: 기존 승인 프로세스의 확장

    Queue Board에서 관리하는 항목은 별도 엔티티가 아니라, **기존 `ApprovalRequest`에 `requestType`을 확장**한 것입니다.

    ```
    Target Source (기존)
      └── ApprovalRequest (기존 엔티티 확장)
            ├── TARGET_CONFIRMATION    ← 기존
            ├── DB_EXCLUSION_REVIEW    ← 신규
            ├── PRD_EXCLUSION_REVIEW   ← 신규
            ├── MODULE_REMOVAL_FULL    ← 신규
            └── MODULE_REMOVAL_PARTIAL ← 신규
    ```

    ### API 역할 분담

    | 역할 | API | Swagger |
    |------|-----|---------|
    | 목록/통계 조회 (전체 TS 횡단) | `GET /task-admin/approval-requests[/summary]` | **이 파일** |
    | 개별 승인/반려 액션 | `POST /target-sources/{id}/approval-requests/approve\|reject` | `confirm.yaml` (재사용) |
    | 승인 요청 생성 | `POST /target-sources/{id}/approval-requests` | `confirm.yaml` (requestType 확장) |
    | 승인 이력 조회 | `GET /target-sources/{id}/approval-history` | `confirm.yaml` (재사용) |

    ### 라우팅

    Next.js: `/task_admin`

servers:
  - url: /api/v1
    description: v1 Base Path

tags:
  - name: Queue Board
    description: |
      관리자 Queue Board — 전체 Target Source를 횡단하여 승인 요청을 집계 조회.
      승인/반려 액션은 기존 `confirm.yaml`의 API를 재사용합니다.

paths:
  /task-admin/approval-requests:
    get:
      tags: [Queue Board]
      summary: 승인 요청 목록 조회 (전체 Target Source 횡단)
      operationId: getApprovalRequestQueue
      x-expected-duration: "500ms ~ 2s"
      description: |
        전체 Target Source에 걸쳐 승인 요청을 집계하여 목록으로 반환합니다.
        필터(요청 유형, 상태), 검색(서비스코드/서비스명), 정렬, 페이지네이션을 지원합니다.

        **참고**: 이 API는 읽기 전용 집계 뷰입니다.
        승인/반려는 `confirm.yaml`의 `POST /target-sources/{id}/approval-requests/approve|reject`를 사용합니다.
      parameters:
        - name: page
          in: query
          required: false
          schema: { type: integer, default: 0 }
          description: "페이지 번호 (0부터 시작)"
        - name: size
          in: query
          required: false
          schema: { type: integer, default: 20 }
          description: "페이지 당 항목 수"
        - name: sort
          in: query
          required: false
          schema: { type: string, default: "requestedAt,desc" }
          description: "정렬 기준 (예: requestedAt,desc / requestedAt,asc)"
        - name: requestType
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/ApprovalRequestType'
          description: "승인 요청 유형 필터"
        - name: status
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/ApprovalRequestStatus'
          description: "승인 요청 상태 필터"
        - name: search
          in: query
          required: false
          schema: { type: string }
          description: "검색어 (서비스코드 또는 서비스명)"
      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalRequestQueueResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/PermissionDenied'

  /task-admin/approval-requests/summary:
    get:
      tags: [Queue Board]
      summary: 승인 요청 요약 통계 조회
      operationId: getApprovalRequestQueueSummary
      x-expected-duration: "300ms ~ 1s"
      description: |
        Queue Board 상단에 표시할 승인 요청 요약 통계를 조회합니다.
        전체 건수, 상태별 건수, 요청 유형별 건수를 반환합니다.
      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalRequestQueueSummary'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/PermissionDenied'

components:
  schemas:
    # ─────────────────────────────────────────────
    # Enums (confirm.yaml의 기존 enum 확장)
    # ─────────────────────────────────────────────
    ApprovalRequestType:
      type: string
      enum:
        - TARGET_CONFIRMATION
        - DB_EXCLUSION_REVIEW
        - PRD_EXCLUSION_REVIEW
        - MODULE_REMOVAL_FULL
        - MODULE_REMOVAL_PARTIAL
      description: |
        승인 요청 유형. 기존 `confirm.yaml`의 ApprovalRequest에 `requestType` 필드로 추가.
        - `TARGET_CONFIRMATION`: 연동 대상 확정 승인 (기존)
        - `DB_EXCLUSION_REVIEW`: 연동 대상 확정 중 일부 DB(dev, stg) 제외 사유 확인
        - `PRD_EXCLUSION_REVIEW`: PRD DB 연동 대상 제외 여부 확인
        - `MODULE_REMOVAL_FULL`: 전체 인프라 모니터링 모듈 제거 (EoS, IRP 폐기, migration)
        - `MODULE_REMOVAL_PARTIAL`: 일부 DB 모니터링 모듈 제거 (DB 변경)

    ApprovalRequestStatus:
      type: string
      enum:
        - PENDING
        - APPROVED
        - REJECTED
      description: |
        기존 ApprovalRequest 상태와 동일.
        - `PENDING`: 접수됨, 관리자 처리 대기
        - `APPROVED`: 관리자 승인 완료
        - `REJECTED`: 관리자 반려 (사유 포함)

    RemovalReason:
      type: string
      enum:
        - END_OF_SERVICE
        - IRP_DISPOSAL
        - INFRASTRUCTURE_MIGRATION
        - DB_CHANGE
        - OTHER
      description: |
        모니터링 모듈 제거 사유 (MODULE_REMOVAL 유형 전용):
        - `END_OF_SERVICE`: EoS (서비스 종료)
        - `IRP_DISPOSAL`: IRP 폐기
        - `INFRASTRUCTURE_MIGRATION`: 타 인프라 migration
        - `DB_CHANGE`: DB 변경
        - `OTHER`: 기타

    CloudProvider:
      type: string
      enum: [AWS, Azure, GCP, IDC, SDU]

    # ─────────────────────────────────────────────
    # Queue Board 응답 (읽기 전용 집계)
    # ─────────────────────────────────────────────
    ApprovalRequestQueueResponse:
      type: object
      required: [content, page]
      properties:
        content:
          type: array
          items:
            $ref: '#/components/schemas/ApprovalRequestQueueItem'
        page:
          $ref: '#/components/schemas/PageInfo'

    ApprovalRequestQueueItem:
      type: object
      required:
        - approvalRequestId
        - targetSourceId
        - requestType
        - status
        - systemInfo
        - requestedAt
        - requestedBy
      description: |
        Queue Board 테이블의 한 행. 기존 ApprovalRequest + Target Source 정보를 조인한 뷰.
      properties:
        approvalRequestId:
          type: string
          description: "기존 ApprovalRequest ID (승인/반려 시 사용)"
          example: "ar_01H8X..."
        targetSourceId:
          type: integer
          format: int64
          description: "Target Source ID (기존 approve/reject API 호출 및 상세 페이지 진입에 필요)"
          example: 42
        requestType:
          $ref: '#/components/schemas/ApprovalRequestType'
        requestTypeName:
          type: string
          description: "요청 유형 표시명 (UI용)"
          example: "연동 대상 확정 — DB 제외 사유 확인"
        status:
          $ref: '#/components/schemas/ApprovalRequestStatus'
        systemInfo:
          $ref: '#/components/schemas/SystemInfo'
        requestedAt:
          type: string
          format: date-time
          description: "요청일시"
        requestedBy:
          type: string
          description: "요청 담당자명"
          example: "홍길동"
        completedAt:
          type: string
          format: date-time
          nullable: true
          description: "처리 완료일시 (승인/반려 시)"
        processedBy:
          type: string
          nullable: true
          description: "처리 담당자명 (승인/반려 시)"
          example: "김관리"
        rejectionReason:
          type: string
          nullable: true
          description: "반려 사유 (REJECTED 상태에서만)"

    SystemInfo:
      type: object
      required: [serviceCode, serviceName, provider]
      properties:
        serviceCode:
          type: string
          description: "서비스 코드"
          example: "SVC001"
        serviceName:
          type: string
          description: "서비스명"
          example: "결제 시스템"
        provider:
          $ref: '#/components/schemas/CloudProvider'

    ApprovalRequestQueueSummary:
      type: object
      required: [total, byStatus, byRequestType]
      properties:
        total:
          type: integer
          description: "전체 승인 요청 건수"
          example: 12
        byStatus:
          type: object
          required: [pending, approved, rejected]
          properties:
            pending: { type: integer, example: 5 }
            approved: { type: integer, example: 4 }
            rejected: { type: integer, example: 3 }
        byRequestType:
          type: object
          required:
            - targetConfirmation
            - dbExclusionReview
            - prdExclusionReview
            - moduleRemovalFull
            - moduleRemovalPartial
          properties:
            targetConfirmation: { type: integer, example: 3 }
            dbExclusionReview: { type: integer, example: 2 }
            prdExclusionReview: { type: integer, example: 1 }
            moduleRemovalFull: { type: integer, example: 4 }
            moduleRemovalPartial: { type: integer, example: 2 }

    # ─────────────────────────────────────────────
    # confirm.yaml 스키마 확장 제안
    # (이 파일에서 참조 정의, 실제 반영은 confirm.yaml에)
    # ─────────────────────────────────────────────
    ApprovalRequestCreateExtension:
      description: |
        **confirm.yaml 확장 제안**: 기존 `ApprovalRequestCreateRequest`에 추가할 필드.
        이 스키마는 참조용이며, 실제 반영은 `confirm.yaml`에서 수행합니다.
      type: object
      properties:
        requestType:
          $ref: '#/components/schemas/ApprovalRequestType'
          description: "승인 요청 유형. 미지정 시 TARGET_CONFIRMATION (기존 동작 유지)"
        exclusion_data:
          $ref: '#/components/schemas/ExclusionReviewData'
        removal_data:
          $ref: '#/components/schemas/ModuleRemovalData'

    ExclusionReviewData:
      type: object
      description: "DB_EXCLUSION_REVIEW / PRD_EXCLUSION_REVIEW 요청 시 포함되는 데이터"
      required: [excluded_databases]
      properties:
        excluded_databases:
          type: array
          items:
            $ref: '#/components/schemas/ExcludedDatabaseInfo'

    ExcludedDatabaseInfo:
      type: object
      required: [resource_id, resource_name, resource_type, exclusion_reason]
      properties:
        resource_id:
          type: string
          description: "리소스 식별자"
        resource_name:
          type: string
          description: "DB 리소스명"
          example: "payment-db-dev"
        resource_type:
          type: string
          description: "DB 유형 (RDS, AZURE_MSSQL 등)"
          example: "RDS"
        environment:
          type: string
          description: "환경 구분"
          example: "dev"
        exclusion_reason:
          type: string
          description: "제외 사유"
          example: "개발 환경 DB — 모니터링 대상 아님"

    ModuleRemovalData:
      type: object
      description: "MODULE_REMOVAL_FULL / MODULE_REMOVAL_PARTIAL 요청 시 포함되는 데이터"
      required: [removal_reason, target_databases]
      properties:
        removal_reason:
          $ref: '#/components/schemas/RemovalReason'
        removal_reason_detail:
          type: string
          nullable: true
          description: "제거 사유 상세 설명"
          example: "2026년 3월 말 EoS 예정, 대체 시스템으로 migration 완료"
        target_databases:
          type: array
          items:
            $ref: '#/components/schemas/RemovalTargetDatabaseInfo'

    RemovalTargetDatabaseInfo:
      type: object
      required: [resource_id, resource_name, resource_type]
      properties:
        resource_id:
          type: string
        resource_name:
          type: string
          example: "payment-db-prd-01"
        resource_type:
          type: string
          example: "RDS"
        monitoring_module_type:
          type: string
          enum: [AGENT, SDU]
          description: "설치된 모니터링 모듈 유형"

    # ─────────────────────────────────────────────
    # Common (confirm.yaml과 동일 구조)
    # ─────────────────────────────────────────────
    PageInfo:
      type: object
      required: [totalElements, totalPages, number, size]
      properties:
        totalElements: { type: integer, example: 15 }
        totalPages: { type: integer, example: 2 }
        number: { type: integer, description: "현재 페이지 번호 (0-based)" }
        size: { type: integer, description: "요청한 페이지 당 항목 수" }

    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code: { type: string }
            message: { type: string }

  responses:
    Unauthorized:
      description: "인증 실패 (SSO 토큰 만료 또는 미인증)"
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorResponse' }
          example:
            error: { code: "UNAUTHORIZED", message: "인증이 필요합니다." }
    PermissionDenied:
      description: "인가 실패 (관리자 권한 필요)"
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorResponse' }
          example:
            error: { code: "FORBIDDEN", message: "관리자 권한이 필요합니다." }
