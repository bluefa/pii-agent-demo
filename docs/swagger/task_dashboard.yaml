openapi: 3.0.3
info:
  title: Task Dashboard API
  version: 1.0.0
  description: |
    PII 모니터링 모듈 관련 PM/개발 개입이 필요한 Task를 관리하는 Queue Board API입니다.

    **주요 기능:**
    1. **Task Queue Board**: 관리자가 대기 중인 Task를 일괄 조회하고 승인/반려 처리
    2. **Task 이력 관리**: Task 생성, 승인, 반려, 재요청 이력 추적
    3. **원천 담당자 조회**: 요청한 Task의 상태 및 반려 사유 확인

    **Task 유형:**
    - `DB_EXCLUSION_REVIEW`: 연동 대상 확정 중 일부 DB 제외 사유 확인 (dev, stg 등)
    - `PRD_EXCLUSION_REVIEW`: PRD DB 연동 대상 제외 여부 확인
    - `MODULE_REMOVAL_FULL`: 전체 인프라 모니터링 모듈 제거 (EoS, IRP 폐기, 타 인프라 migration)
    - `MODULE_REMOVAL_PARTIAL`: 일부 DB 모니터링 모듈 제거 (DB 변경 케이스)

    **라우팅**: `/task_admin`

servers:
  - url: /api/v1
    description: v1 Base Path

tags:
  - name: Task Admin
    description: 관리자 Task Queue Board — Task 목록 조회, 승인/반려 처리
  - name: Task Source
    description: 원천 담당자 — Task 생성, 본인 요청 Task 조회

paths:
  # ─────────────────────────────────────────────
  # 관리자 API
  # ─────────────────────────────────────────────
  /task-admin/tasks:
    get:
      tags: [Task Admin]
      summary: Task 목록 조회
      operationId: getTaskList
      x-expected-duration: "500ms 이내"
      description: |
        관리자 Queue Board에서 Task 목록을 조회합니다.
        필터(유형, 상태), 검색(서비스코드/서비스명), 정렬, 페이지네이션을 지원합니다.
      parameters:
        - name: page
          in: query
          required: false
          schema: { type: integer, default: 0 }
          description: "페이지 번호 (0부터 시작)"
        - name: size
          in: query
          required: false
          schema: { type: integer, default: 20 }
          description: "페이지 당 항목 수"
        - name: sort
          in: query
          required: false
          schema: { type: string, default: "requestedAt,desc" }
          description: "정렬 기준 (예: requestedAt,desc / requestedAt,asc)"
        - name: taskType
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/TaskType'
          description: "Task 유형 필터"
        - name: status
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/TaskStatus'
          description: "Task 상태 필터"
        - name: search
          in: query
          required: false
          schema: { type: string }
          description: "검색어 (서비스코드 또는 서비스명)"
      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/PermissionDenied'

  /task-admin/tasks/summary:
    get:
      tags: [Task Admin]
      summary: Task 요약 통계 조회
      operationId: getTaskSummary
      x-expected-duration: "300ms 이내"
      description: |
        Queue Board 상단에 표시할 Task 요약 통계를 조회합니다.
        전체 건수, 상태별 건수, 유형별 건수를 반환합니다.
      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskSummaryResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/PermissionDenied'

  /task-admin/tasks/{taskId}:
    parameters:
      - $ref: '#/components/parameters/TaskId'
    get:
      tags: [Task Admin]
      summary: Task 상세 조회
      operationId: getTaskDetail
      x-expected-duration: "500ms 이내"
      description: |
        Task의 상세 정보를 조회합니다.
        Task 기본 정보, 시스템 정보, 요청 내용(DB 목록/사유), 처리 결과를 포함합니다.
      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskDetailResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/PermissionDenied'
        '404':
          $ref: '#/components/responses/TaskNotFound'

  /task-admin/tasks/{taskId}/approve:
    parameters:
      - $ref: '#/components/parameters/TaskId'
    post:
      tags: [Task Admin]
      summary: Task 승인
      operationId: approveTask
      x-expected-duration: "500ms 이내"
      description: |
        PENDING 상태의 Task를 승인합니다.
        승인 시 Task 상태가 APPROVED로 전환됩니다.
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskApproveRequest'
      responses:
        '200':
          description: 승인 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskActionResponse'
        '400':
          description: "승인 대기 상태가 아님"
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }
              example:
                error: { code: "VALIDATION_FAILED", message: "승인 대기 상태의 Task가 아닙니다." }
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/PermissionDenied'
        '404':
          $ref: '#/components/responses/TaskNotFound'

  /task-admin/tasks/{taskId}/reject:
    parameters:
      - $ref: '#/components/parameters/TaskId'
    post:
      tags: [Task Admin]
      summary: Task 반려
      operationId: rejectTask
      x-expected-duration: "500ms 이내"
      description: |
        PENDING 상태의 Task를 반려합니다.
        반려 사유(`reason`)는 필수이며, 원천 담당자가 조회할 수 있습니다.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskRejectRequest'
      responses:
        '200':
          description: 반려 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskActionResponse'
        '400':
          description: "승인 대기 상태가 아니거나 반려 사유 누락"
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }
              examples:
                invalid_state:
                  summary: 승인 대기 상태가 아님
                  value:
                    error: { code: "VALIDATION_FAILED", message: "승인 대기 상태의 Task가 아닙니다." }
                missing_reason:
                  summary: 반려 사유 누락
                  value:
                    error: { code: "VALIDATION_FAILED", message: "반려 사유를 입력해주세요." }
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/PermissionDenied'
        '404':
          $ref: '#/components/responses/TaskNotFound'

  /task-admin/tasks/{taskId}/history:
    parameters:
      - $ref: '#/components/parameters/TaskId'
    get:
      tags: [Task Admin]
      summary: Task 이력 조회
      operationId: getTaskHistory
      x-expected-duration: "300ms 이내"
      description: |
        Task의 생성, 승인, 반려, 재요청 등의 이력을 시간순으로 조회합니다.
        재요청으로 연결된 이전 Task의 이력도 포함됩니다.
      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskHistoryResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/PermissionDenied'
        '404':
          $ref: '#/components/responses/TaskNotFound'

  # ─────────────────────────────────────────────
  # 원천 담당자 API
  # ─────────────────────────────────────────────
  /target-sources/{targetSourceId}/tasks:
    parameters:
      - $ref: '#/components/parameters/TargetSourceId'
    get:
      tags: [Task Source]
      summary: 해당 시스템의 Task 목록 조회
      operationId: getTasksByTargetSource
      x-expected-duration: "500ms 이내"
      description: |
        특정 Target Source에 대해 생성된 Task 목록을 조회합니다.
        원천 담당자가 본인 시스템의 Task 상태 및 반려 사유를 확인할 때 사용합니다.
      parameters:
        - name: page
          in: query
          required: false
          schema: { type: integer, default: 0 }
        - name: size
          in: query
          required: false
          schema: { type: integer, default: 10 }
      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/PermissionDenied'
        '404':
          $ref: '#/components/responses/TargetSourceNotFound'

    post:
      tags: [Task Source]
      summary: Task 생성 (제외 확인 / 모듈 제거 요청)
      operationId: createTask
      x-expected-duration: "500ms 이내"
      description: |
        원천 담당자가 Task를 생성합니다.
        - DB 연동 제외 사유 확인 (DB_EXCLUSION_REVIEW, PRD_EXCLUSION_REVIEW)
        - 모니터링 모듈 제거 요청 (MODULE_REMOVAL_FULL, MODULE_REMOVAL_PARTIAL)

        재요청 시 `previousTaskId`를 포함하여 이전 Task와 연결합니다.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskCreateRequest'
      responses:
        '201':
          description: Task 생성 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskCreateResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/PermissionDenied'
        '404':
          $ref: '#/components/responses/TargetSourceNotFound'

components:
  parameters:
    TaskId:
      name: taskId
      in: path
      required: true
      schema: { type: string }
      description: "Task 식별자"
      example: "task_01H8X..."

    TargetSourceId:
      name: targetSourceId
      in: path
      required: true
      schema: { type: integer, format: int64 }
      description: "Target Source 식별자"

  schemas:
    # ─────────────────────────────────────────────
    # Enums
    # ─────────────────────────────────────────────
    TaskType:
      type: string
      enum:
        - DB_EXCLUSION_REVIEW
        - PRD_EXCLUSION_REVIEW
        - MODULE_REMOVAL_FULL
        - MODULE_REMOVAL_PARTIAL
      description: |
        - `DB_EXCLUSION_REVIEW`: 연동 대상 확정 중 일부 DB(dev, stg) 제외 사유 확인
        - `PRD_EXCLUSION_REVIEW`: PRD DB 연동 대상 제외 여부 확인
        - `MODULE_REMOVAL_FULL`: 전체 인프라 모니터링 모듈 제거 (EoS, IRP 폐기, migration)
        - `MODULE_REMOVAL_PARTIAL`: 일부 DB 모니터링 모듈 제거 (DB 변경)

    TaskStatus:
      type: string
      enum:
        - PENDING
        - APPROVED
        - REJECTED
      description: |
        - `PENDING`: 접수됨, 관리자 처리 대기
        - `APPROVED`: 관리자 승인 완료
        - `REJECTED`: 관리자 반려 (사유 포함)

    RemovalReason:
      type: string
      enum:
        - END_OF_SERVICE
        - IRP_DISPOSAL
        - INFRASTRUCTURE_MIGRATION
        - DB_CHANGE
        - OTHER
      description: |
        모니터링 모듈 제거 사유:
        - `END_OF_SERVICE`: EoS (서비스 종료)
        - `IRP_DISPOSAL`: IRP 폐기
        - `INFRASTRUCTURE_MIGRATION`: 타 인프라 migration
        - `DB_CHANGE`: DB 변경
        - `OTHER`: 기타

    CloudProvider:
      type: string
      enum: [AWS, Azure, GCP, IDC, SDU]

    # ─────────────────────────────────────────────
    # List & Summary
    # ─────────────────────────────────────────────
    TaskListResponse:
      type: object
      required: [content, page]
      properties:
        content:
          type: array
          items:
            $ref: '#/components/schemas/TaskListItem'
        page:
          $ref: '#/components/schemas/PageInfo'

    TaskListItem:
      type: object
      required: [taskId, taskType, taskName, status, systemInfo, requestedAt, requestedBy]
      properties:
        taskId:
          type: string
          example: "task_01H8X..."
        taskType:
          $ref: '#/components/schemas/TaskType'
        taskName:
          type: string
          description: "Task 표시명 (예: '연동 대상 확정 — DB 제외 사유 확인', 'EoS 전체 제거')"
          example: "연동 대상 확정 — DB 제외 사유 확인"
        status:
          $ref: '#/components/schemas/TaskStatus'
        systemInfo:
          $ref: '#/components/schemas/SystemInfo'
        requestedAt:
          type: string
          format: date-time
          description: "요청일시"
        requestedBy:
          type: string
          description: "요청 담당자명"
          example: "홍길동"
        completedAt:
          type: string
          format: date-time
          nullable: true
          description: "완료일시 (승인/반려 처리일)"
        processedBy:
          type: string
          nullable: true
          description: "승인/반려 처리 담당자명"
          example: "김관리"

    SystemInfo:
      type: object
      required: [serviceCode, serviceName, provider]
      properties:
        serviceCode:
          type: string
          description: "서비스 코드"
          example: "SVC001"
        serviceName:
          type: string
          description: "서비스명"
          example: "결제 시스템"
        provider:
          $ref: '#/components/schemas/CloudProvider'
        targetSourceId:
          type: integer
          format: int64
          description: "Target Source ID (상세 페이지 진입용)"
          example: 42

    TaskSummaryResponse:
      type: object
      required: [total, byStatus, byType]
      properties:
        total:
          type: integer
          description: "전체 Task 건수"
          example: 12
        byStatus:
          type: object
          required: [pending, approved, rejected]
          properties:
            pending:
              type: integer
              example: 5
            approved:
              type: integer
              example: 4
            rejected:
              type: integer
              example: 3
        byType:
          type: object
          required: [dbExclusionReview, prdExclusionReview, moduleRemovalFull, moduleRemovalPartial]
          properties:
            dbExclusionReview:
              type: integer
              example: 3
            prdExclusionReview:
              type: integer
              example: 2
            moduleRemovalFull:
              type: integer
              example: 4
            moduleRemovalPartial:
              type: integer
              example: 3

    # ─────────────────────────────────────────────
    # Detail
    # ─────────────────────────────────────────────
    TaskDetailResponse:
      type: object
      required: [task]
      properties:
        task:
          $ref: '#/components/schemas/TaskDetail'

    TaskDetail:
      type: object
      required: [taskId, taskType, taskName, status, systemInfo, requestedAt, requestedBy, taskData]
      properties:
        taskId:
          type: string
        taskType:
          $ref: '#/components/schemas/TaskType'
        taskName:
          type: string
        status:
          $ref: '#/components/schemas/TaskStatus'
        systemInfo:
          $ref: '#/components/schemas/SystemInfo'
        requestedAt:
          type: string
          format: date-time
        requestedBy:
          type: string
        completedAt:
          type: string
          format: date-time
          nullable: true
        processedBy:
          type: string
          nullable: true
        rejectionReason:
          type: string
          nullable: true
          description: "반려 사유 (REJECTED 상태에서만 존재)"
        previousTaskId:
          type: string
          nullable: true
          description: "재요청 시 이전 Task ID (이력 추적용)"
        taskData:
          $ref: '#/components/schemas/TaskData'

    TaskData:
      description: "Task 유형별 상세 데이터"
      oneOf:
        - $ref: '#/components/schemas/DbExclusionReviewData'
        - $ref: '#/components/schemas/ModuleRemovalData'
      discriminator:
        propertyName: type

    DbExclusionReviewData:
      type: object
      required: [type, excludedDatabases]
      properties:
        type:
          type: string
          enum: [DB_EXCLUSION_REVIEW, PRD_EXCLUSION_REVIEW]
        excludedDatabases:
          type: array
          description: "제외 대상 DB 목록"
          items:
            $ref: '#/components/schemas/ExcludedDatabase'

    ExcludedDatabase:
      type: object
      required: [resourceId, resourceName, resourceType, exclusionReason]
      properties:
        resourceId:
          type: string
          description: "리소스 식별자"
        resourceName:
          type: string
          description: "DB 리소스명"
          example: "payment-db-dev"
        resourceType:
          type: string
          description: "DB 유형 (RDS, AZURE_MSSQL 등)"
          example: "RDS"
        environment:
          type: string
          description: "환경 구분 (dev, stg, prd)"
          example: "dev"
        exclusionReason:
          type: string
          description: "제외 사유"
          example: "개발 환경 DB — 모니터링 대상 아님"

    ModuleRemovalData:
      type: object
      required: [type, removalReason, targetDatabases]
      properties:
        type:
          type: string
          enum: [MODULE_REMOVAL_FULL, MODULE_REMOVAL_PARTIAL]
        removalReason:
          $ref: '#/components/schemas/RemovalReason'
        removalReasonDetail:
          type: string
          nullable: true
          description: "제거 사유 상세 설명"
          example: "2026년 3월 말 EoS 예정, 대체 시스템으로 migration 완료"
        targetDatabases:
          type: array
          description: "제거 대상 DB 목록"
          items:
            $ref: '#/components/schemas/RemovalTargetDatabase'

    RemovalTargetDatabase:
      type: object
      required: [resourceId, resourceName, resourceType]
      properties:
        resourceId:
          type: string
        resourceName:
          type: string
          example: "payment-db-prd-01"
        resourceType:
          type: string
          example: "RDS"
        monitoringModuleType:
          type: string
          enum: [AGENT, SDU]
          description: "설치된 모니터링 모듈 유형"

    # ─────────────────────────────────────────────
    # Actions
    # ─────────────────────────────────────────────
    TaskApproveRequest:
      type: object
      properties:
        comment:
          type: string
          nullable: true
          description: "승인 코멘트 (선택)"

    TaskRejectRequest:
      type: object
      required: [reason]
      properties:
        reason:
          type: string
          minLength: 1
          description: "반려 사유 (필수, 원천 담당자에게 노출)"
          example: "PRD DB가 제외 대상에 포함되어 있습니다. 의도를 확인해주세요."

    TaskActionResponse:
      type: object
      required: [success, taskId, status, processedAt]
      properties:
        success:
          type: boolean
        taskId:
          type: string
        status:
          $ref: '#/components/schemas/TaskStatus'
        processedAt:
          type: string
          format: date-time
        processedBy:
          type: string
          description: "처리 담당자명"
        reason:
          type: string
          nullable: true
          description: "반려 사유 (REJECTED 시)"

    # ─────────────────────────────────────────────
    # History
    # ─────────────────────────────────────────────
    TaskHistoryResponse:
      type: object
      required: [taskId, events]
      properties:
        taskId:
          type: string
        events:
          type: array
          items:
            $ref: '#/components/schemas/TaskHistoryEvent'

    TaskHistoryEvent:
      type: object
      required: [eventType, occurredAt, actor]
      properties:
        eventType:
          type: string
          enum:
            - CREATED
            - APPROVED
            - REJECTED
            - RESUBMITTED
          description: |
            - `CREATED`: Task 생성
            - `APPROVED`: 관리자 승인
            - `REJECTED`: 관리자 반려
            - `RESUBMITTED`: 원천 담당자 재요청
        occurredAt:
          type: string
          format: date-time
        actor:
          type: string
          description: "이벤트 수행자명"
        detail:
          type: string
          nullable: true
          description: "이벤트 상세 (반려 사유, 승인 코멘트 등)"

    # ─────────────────────────────────────────────
    # Create (원천 담당자)
    # ─────────────────────────────────────────────
    TaskCreateRequest:
      type: object
      required: [taskType, taskData]
      properties:
        taskType:
          $ref: '#/components/schemas/TaskType'
        previousTaskId:
          type: string
          nullable: true
          description: "재요청 시 이전 Task ID"
        taskData:
          $ref: '#/components/schemas/TaskData'

    TaskCreateResponse:
      type: object
      required: [success, task]
      properties:
        success:
          type: boolean
        task:
          $ref: '#/components/schemas/TaskListItem'

    # ─────────────────────────────────────────────
    # Common
    # ─────────────────────────────────────────────
    PageInfo:
      type: object
      required: [totalElements, totalPages, number, size]
      properties:
        totalElements:
          type: integer
          example: 15
        totalPages:
          type: integer
          example: 2
        number:
          type: integer
          description: "현재 페이지 번호 (0-based)"
        size:
          type: integer
          description: "요청한 페이지 당 항목 수"

    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code: { type: string }
            message: { type: string }

  responses:
    Unauthorized:
      description: "인증 실패 (SSO 토큰 만료 또는 미인증)"
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorResponse' }
          example:
            error: { code: "UNAUTHORIZED", message: "인증이 필요합니다." }
    PermissionDenied:
      description: "인가 실패 (관리자 권한 필요)"
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorResponse' }
          example:
            error: { code: "FORBIDDEN", message: "관리자 권한이 필요합니다." }
    TaskNotFound:
      description: "Task를 찾을 수 없음"
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorResponse' }
          example:
            error: { code: "TASK_NOT_FOUND", message: "해당 ID의 Task가 존재하지 않습니다." }
    TargetSourceNotFound:
      description: "Target Source를 찾을 수 없음"
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorResponse' }
          example:
            error: { code: "TARGET_SOURCE_NOT_FOUND", message: "해당 ID의 Target Source가 존재하지 않습니다." }
    BadRequest:
      description: "잘못된 요청 파라미터"
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorResponse' }
          example:
            error: { code: "VALIDATION_FAILED", message: "요청 파라미터가 올바르지 않습니다." }
