# ADR-006: 연동 확정 승인 프로세스 재설계

## 상태
제안됨

## 날짜
2026-02-11

## 맥락

기존 연동 확정 정보는 Terraform 라이프사이클과 직접 결합되어 있어 수정이 어렵다.

- Infra manager가 확정 정보 수정을 제공하지 않음
- 확정 정보를 삭제하면 Terraform 관리 리소스가 고아 상태가 됨
- Terraform 삭제를 기다리면 반영 시간이 과도하게 길어짐

Self Installation Tool에서 사용자가 언제든 연동 대상 변경을 요청할 수 있는 UX를 제공해야 하므로, 기존 구조를 변경할 필요가 있다.

관련 이슈: #101, #104

## 결정

### D-001: 3개 객체 분리

연동 관련 데이터를 3개 객체로 분리한다.

| 객체 | 의미 | 수명 |
|------|------|------|
| 연동 확정 정보 | Terraform이 관리 중인 실제 상태 | TF 삭제 전까지 유지 |
| 승인 요청 정보 | 사용자가 원하는 미래 상태 | 승인/반려 시 소멸 |
| 승인 완료 정보 | 승인되었으나 확정 정보에 미반영 | 확정 정보에 반영 완료 시 소멸 |

**근거**: 확정 정보가 Terraform 라이프사이클과 엮여있어 직접 수정이 불가능. 객체를 분리하지 않으면 "현재 상태 / 요청 중 / 반영 중"을 플래그로 구분해야 하며 이는 버그에 취약하다.

**상태: 결정됨**

### D-002: 승인 요청 중 스캔 및 재요청 정책

- 스캔은 언제든 수행 가능 (승인 요청 상태와 무관)
- 승인 요청이 진행 중인 동안 **추가 승인 요청은 불가**
- 승인 요청을 취소한 후 새로운 승인 요청을 할 수 있음

**근거**: 동시에 여러 승인 요청이 존재하면 어떤 요청이 반영되는지 모호해지고, 관리자 승인 workflow가 복잡해진다. 스캔은 정보 수집이므로 제한할 이유가 없다.

**상태: 결정됨**

### D-003: 과도기 상태의 UI 표시 우선순위

확정 정보와 승인 완료 정보가 동시에 존재하는 과도기:

- **승인 완료 정보를 우선 표시**
- "승인 완료된 내용이 반영되고 있는 중입니다" + Black Box 진행 지표
- 확정 정보(이전 상태)는 "이전 연동 정보 보기" 접힌 영역으로 제공

**근거**: 사용자의 관심사는 "내가 요청한 것이 처리되고 있는가"이지 "이전에 뭐가 적용되어 있었는가"가 아니다.

**상태: 결정됨**

### D-004: Black Box 모델

설치 진행 상태를 3개 지표로 추상화하여 내부 인프라 복잡성을 숨긴다:

1. 입력 반영 상태
2. 서비스 측 Terraform 설치 상태
3. BDC Terraform 설치 상태

표시 방식: 통합 프로그레스 바(기본 뷰) + 상세 지표(확장 뷰)

**상태: 결정됨**

### D-005: 반려 후 사용자 경로

반려 시 사용자에게 두 가지 경로를 명시적으로 제공:

- "확정 정보 수정 후 재요청" → 1단계(WAITING_TARGET_CONFIRMATION)로 회귀
- "동일 정보로 재요청" → 승인 요청을 바로 재제출

반려 사유를 요약하여 표시하고, CTA 버튼으로 다음 행동을 유도한다.

**상태: 논의 필요**

### D-006: Empty State 맥락 분류

"확정 정보 없음" 상태를 맥락별로 다르게 안내:

| 맥락 | 안내 |
|------|------|
| 최초 진입 | "연동할 리소스를 스캔하고 선택하세요" |
| 반려 후 복귀 | 반려 사유 + "수정 후 재요청" 안내. 이전 선택 정보 유지 |
| 재확정 필요 | 새 리소스 발견 안내 + 변경 diff |

**상태: 논의 필요**

### D-007: 승인 완료 → 확정 정보 반영 실패 시 처리

승인은 완료되었으나 확정 정보에 반영할 수 없는 경우의 UX 및 롤백 정책.

단계적 공개 방식 제안:
1. 기본 뷰: "반영에 실패했습니다" + CTA 1개
2. CTA 분기: 사용자 수정 가능 문제 vs 시스템 문제
3. 상세 보기: 접힌 영역으로 기술적 상세 제공

상세 정의: #104

**상태: 논의 필요**

## 결과

- Terraform 라이프사이클과 UX 레이어가 분리되어 사용자 경험이 개선됨
- 3개 객체 간 전이 규칙이 명확해져 프론트엔드 렌더링 로직이 단순해짐
- 관리자 승인 workflow와 사용자 변경 요청이 독립적으로 관리 가능

## 관련

- #101: 연동 확정 승인에 대한 내역 정리
- #104: 승인 완료 → 확정 정보 반영 실패 시 UX 및 롤백 정책
- [ADR-001](./001-process-state-architecture.md): Process 상태 관리 아키텍처
- [ADR-004](./004-process-status-refactoring.md): processStatus 저장 필드 리팩토링
