# ADR-006: 연동 확정 승인 프로세스 재설계

## 상태
제안됨

## 날짜
2026-02-11

## 맥락

기존 연동 확정 정보는 Terraform 라이프사이클과 직접 결합되어 있어 수정이 어렵다.

- Infra manager가 확정 정보 수정을 제공하지 않음
- 확정 정보를 삭제하면 Terraform 관리 리소스가 고아 상태가 됨
- Terraform 삭제를 기다리면 반영 시간이 과도하게 길어짐

Self Installation Tool에서 사용자가 언제든 연동 대상 변경을 요청할 수 있는 UX를 제공해야 하므로, 기존 구조를 변경할 필요가 있다.

관련 이슈: #101, #104

## 결정

### D-001: 3개 객체 분리

연동 관련 데이터를 3개 객체로 분리한다.

| 객체 | 의미 | 수명 |
|------|------|------|
| 연동 확정 정보 | Terraform이 관리 중인 실제 상태 | TF 삭제 전까지 유지 |
| 승인 요청 정보 | 사용자가 원하는 미래 상태 | 승인/반려 시 소멸 |
| 승인 완료 정보 | 승인되었으나 확정 정보에 미반영 | 확정 정보에 반영 완료 시 소멸 |

**근거**: 확정 정보가 Terraform 라이프사이클과 엮여있어 직접 수정이 불가능. 객체를 분리하지 않으면 "현재 상태 / 요청 중 / 반영 중"을 플래그로 구분해야 하며 이는 버그에 취약하다.

**상태: 결정됨**

### D-002: 승인 요청 중 스캔 및 재요청 정책

- 스캔은 언제든 수행 가능 (승인 요청 상태와 무관)
- 승인 요청이 진행 중인 동안 **추가 승인 요청은 불가**
- 승인 요청을 취소한 후 새로운 승인 요청을 할 수 있음

**근거**: 동시에 여러 승인 요청이 존재하면 어떤 요청이 반영되는지 모호해지고, 관리자 승인 workflow가 복잡해진다. 스캔은 정보 수집이므로 제한할 이유가 없다.

**상태: 결정됨**

### D-003: 과도기 상태의 UI 표시 우선순위

확정 정보와 승인 완료 정보가 동시에 존재하는 과도기:

- **승인 완료 정보를 우선 표시**
- "승인 완료된 내용이 반영되고 있는 중입니다" + Black Box 진행 지표
- 확정 정보(이전 상태)는 "이전 연동 정보 보기" 접힌 영역으로 제공

**근거**: 사용자의 관심사는 "내가 요청한 것이 처리되고 있는가"이지 "이전에 뭐가 적용되어 있었는가"가 아니다.

**상태: 결정됨**

### D-008: 반영 중 새 승인 요청 차단

승인 완료 정보가 확정 정보에 반영되는 동안 **새로운 승인 요청을 차단**한다.

이 정책으로 3개 객체(확정/요청/완료)가 동시에 존재하는 상태를 원천 차단하며, 가능한 상태 조합이 6가지로 고정된다:

| 확정 | 요청 | 완료 | 상태 | 다음 전이 |
|:---:|:---:|:---:|------|----------|
| X | X | X | 최초 진입 | → 요청 생성 |
| X | O | X | 최초 승인 요청 중 | → 승인/반려 |
| X | X | O | 최초 반영 중 | → 반영 완료 시 확정 생성 |
| O | X | X | 연동 완료 | → 요청 생성 |
| O | O | X | 변경 요청 중 | → 승인/반려 |
| O | X | O | 기존 유지 + 반영 중 | → 반영 완료 시 확정 교체 |

**근거**: 반영 중에 새 요청을 허용하면 3개 객체가 동시에 존재하게 되고, 이때 반영 완료로 확정이 교체되면 요청이 이전 확정 기준으로 작성된 것이라 정합성이 깨진다. 차단하면 모든 상태에서 다음 전이가 단일 경로로 명확해진다.

**calculator 변경 필요**: 현재 `targets.confirmed` boolean만으로 판단하는 로직에 승인 완료 정보 존재 여부를 추가해야 한다. 승인 완료 정보가 존재하면 `WAITING_TARGET_CONFIRMATION`이 아닌 "반영 중" 상태를 반환해야 확정 정보 삭제 시 UI가 1단계로 튕기는 문제를 방지할 수 있다.

**별도 관리 영역** (상태 전이와 무관):
- 반영 실패 시 복구 → #104
- 반려 이력 보존 → History 저장으로 해결 (객체 소멸과 별개)

**상태: 결정됨**

### D-009: 승인 요청/완료 단일 존재 제약 및 데이터 스키마

승인 요청 정보(`ApprovalRequest`)와 승인 완료 정보(`ApprovedIntegration`) 중 **최대 하나만 존재 가능**하다. 객체의 존재 자체가 상태를 의미하며 별도 status 필드가 불필요하다.

```typescript
interface ResourceInfo {
  resource_id: string;
  resource_type: ResourceType;
  vm_config?: {                // VM인 경우
    db_type: string;
    port: number;
    host: string;
  };
  credential?: string;
}

// 존재 = "승인 요청 중"
interface ApprovalRequest {
  id: string;
  requested_at: string;
  requested_by: { id: string; name: string };
  resource_infos: ResourceInfo[];
  exclusions?: {
    resource_ids: string[];
    reason: string;
  };
}

// 존재 = "반영 중"
interface ApprovedIntegration {
  id: string;
  approved_at: string;
  approved_by: { id: string; name: string } | null; // null = 자동 승인
  resource_infos: ResourceInfo[];
  exclusions?: {
    resource_ids: string[];
    reason: string;
  };
  reflection: {
    input_reflected: boolean;       // Black Box 지표 1
    service_tf_installed: boolean;  // Black Box 지표 2
    bdc_tf_installed: boolean;      // Black Box 지표 3
  };
}
```

**calculator 판단 로직**:
```
ApprovalRequest 존재?     → 승인 대기
ApprovedIntegration 존재? → 반영 중 (Black Box)
둘 다 없음?              → targets.confirmed 확인
```

**근거**: D-002(승인 요청 중 추가 요청 불가)와 D-008(반영 중 새 요청 차단)을 하나의 제약으로 통합. 객체 존재 여부만으로 상태를 판단하므로 플래그 기반 관리보다 버그에 강하다.

**상태: 결정됨**

### D-004: Black Box 모델

설치 진행 상태를 3개 지표로 추상화하여 내부 인프라 복잡성을 숨긴다:

1. 입력 반영 상태
2. 서비스 측 Terraform 설치 상태
3. BDC Terraform 설치 상태

표시 방식: 통합 프로그레스 바(기본 뷰) + 상세 지표(확장 뷰)

**상태: 결정됨**

### D-005: 반려 후 처리

반려 시 승인 요청 정보가 소멸되며, 사용자에게 **반려 사유만 표시**한다.

- 확정 정보가 있는 경우: 기존 연동 유지 상태(O/X/X)로 복귀 + 반려 안내
- 확정 정보가 없는 경우: 최초 진입 상태(X/X/X)로 복귀 + 반려 안내

리소스 수정 여부는 사용자가 판단하며, UI에서 경로를 분기하지 않는다. 반려 이력은 History에 별도 저장하여 요청 객체 소멸 후에도 조회 가능하게 한다.

**상태: 결정됨**

### D-006: Empty State 맥락 분류

"확정 정보 없음"(X/X/X) 상태에서는 "연동 정보 입력" 안내를 표시한다. 반려/시스템 에러 이력이 있는 경우 해당 사유를 함께 표시한다.

별도 UI 분기 없이 D-005(반려 사유 표시), D-007(시스템 에러 안내)의 이력 표시로 충분하다.

**상태: 결정됨**

### D-007: 승인 완료 → 확정 정보 반영 실패 시 처리

승인은 완료되었으나 Infra Manager에서 연동 확정이 불가능한 경우 (일시적 서버 에러가 아닌 비즈니스 실패):

- 승인 시점 이후 리소스가 삭제된 경우
- 연동이 불가능한 구성인 경우

**처리 방식**: 시스템 에러로 분류하고 **승인 완료 정보를 삭제**한다.

- 확정 정보가 있는 경우: O/X/X (연동 완료)로 복귀 + 시스템 에러 안내
- 확정 정보가 없는 경우 (반영 도중 기존 TF 정리 후 실패): X/X/X (최초 진입)로 복귀 + 시스템 에러 안내

상태 전이 패턴은 반려(D-005)와 동일하다. 사용자에게 에러 사유를 안내하면 충분하며, 별도 복구 로직은 불필요하다.

상세 정의: #104

**상태: 결정됨**

## 결과

- Terraform 라이프사이클과 UX 레이어가 분리되어 사용자 경험이 개선됨
- 3개 객체 간 전이 규칙이 명확해져 프론트엔드 렌더링 로직이 단순해짐
- 관리자 승인 workflow와 사용자 변경 요청이 독립적으로 관리 가능

## 관련

- #101: 연동 확정 승인에 대한 내역 정리
- #104: 승인 완료 → 확정 정보 반영 실패 시 UX 및 롤백 정책
- [ADR-001](./001-process-state-architecture.md): Process 상태 관리 아키텍처
- [ADR-004](./004-process-status-refactoring.md): processStatus 저장 필드 리팩토링
