# ADR-006 승인 프로세스 UX 설계

> 관련: ADR-006, Issues #110~#116

## 1. 전체 사용자 흐름 요약

```
[스캔 완료] → 리소스 선택 → "승인 요청" → 승인 대기 → 승인/반려/취소
                                                         ↓
                                              승인 → 반영 중 (Black Box) → 연동 완료
                                              반려 → 반려 사유 표시 → 재선택 가능
                                              취소 → 원래 상태 복귀 → 재선택 가능
```

사용자(서비스 담당자)와 관리자의 역할이 분리된다:
- **서비스 담당자**: 리소스 선택 → 승인 요청 / 취소
- **관리자**: 승인 / 반려

---

## 2. 6가지 상태별 화면 구성

> 표기법: `확정/요청/완료` (O=존재, X=없음)

### 2-1. X/X/X — 최초 진입

프로젝트 생성 직후 또는 반려/에러 후 확정 정보가 없는 상태.

```
┌─────────────────────────────────────────────────────────┐
│ Step 1. 연동 대상 확인          ← StepIndicator 활성    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  (반려 이력 있을 경우)                                    │
│  ┌─ ⚠ 배너 ──────────────────────────────────────────┐  │
│  │ 이전 승인 요청이 반려되었습니다: "{반려 사유}"       │  │
│  │                                         [닫기 ✕]  │  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
│  (시스템 에러 이력 있을 경우)                              │
│  ┌─ ⚠ 배너 ──────────────────────────────────────────┐  │
│  │ 시스템 오류로 이전 연동 반영이 실패했습니다.          │  │
│  │ 연동 대상을 다시 확인해주세요.           [닫기 ✕]   │  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
│  스캔된 리소스 목록                                      │
│  ┌───────────────────────────────────────────────────┐  │
│  │ ☑ rds-prod-01    RDS    ap-northeast-2   TARGET   │  │
│  │ ☑ rds-prod-02    RDS    ap-northeast-2   TARGET   │  │
│  │ ☐ rds-dev-01     RDS    ap-northeast-2   TARGET   │  │
│  │ ── ec2-web-01    EC2    ap-northeast-2   설치불필요│  │
│  │ ── elb-main      ELB    ap-northeast-2   설치불가  │  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
│  ※ TARGET 리소스만 체크박스 선택 가능                     │
│  ※ NO_INSTALL_NEEDED, INSTALL_INELIGIBLE은 분류 표시만   │
│                                                         │
│  (TARGET 미선택 시)                                      │
│  ┌─ 제외 사유 입력 ─────────────────────────────────┐   │
│  │ 미선택 리소스 제외 사유: [________________]        │   │
│  └──────────────────────────────────────────────────┘   │
│                                                         │
│                              [승인 요청]  ← 기본 액션    │
└─────────────────────────────────────────────────────────┘
```

**인터랙션**:
- `integrationCategory`에 따라 리소스 분류 표시
- TARGET 리소스 중 미선택 항목이 있으면 제외 사유 입력 영역 노출
- "승인 요청" 클릭 → `POST /confirm-targets` 호출
- Azure VM의 경우 VM 설정 패널이 함께 노출됨

---

### 2-2. O/X/X — 연동 완료

승인이 반영되어 Terraform으로 관리 중인 상태.

```
┌─────────────────────────────────────────────────────────┐
│ Step 3~5. 설치 중 / 연결 테스트 / 완료                   │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  (반려 이력 있을 경우 — 변경 요청 후 반려됨)               │
│  ┌─ ⚠ 배너 ──────────────────────────────────────────┐  │
│  │ 변경 요청이 반려되었습니다: "{반려 사유}"            │  │
│  │ 기존 연동 정보가 유지됩니다.             [닫기 ✕]   │  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
│  현재 연동된 리소스 목록 (읽기 전용)                      │
│  ┌───────────────────────────────────────────────────┐  │
│  │ rds-prod-01    RDS    ap-northeast-2    연결됨 ●   │  │
│  │ rds-prod-02    RDS    ap-northeast-2    연결됨 ●   │  │
│  │ s3-backup      S3     ap-northeast-2    연결됨 ●   │  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
│  제외된 리소스: rds-dev-01 (사유: 개발 환경)              │
│                                                         │
│                       [연동 대상 변경]  ← 보조 액션       │
└─────────────────────────────────────────────────────────┘
```

**인터랙션**:
- 연동된 리소스 목록을 읽기 전용으로 표시
- 연결 상태(ConnectionIndicator)와 함께 표시
- "연동 대상 변경" 클릭 → 리소스 선택 화면(2-1과 유사)으로 전환, 기존 선택 상태 반영

> **[결정 포인트 DP-01]** "연동 대상 변경" 클릭 시 동작
>
> 현재 2-1(X/X/X) 화면과 동일한 리소스 선택 화면을 사용하되 기존 선택 상태를 pre-check하는 방식을 제안합니다.
> 다만, 이 화면이 O/X/X 상태에서 보이므로 StepIndicator는 현재 Step(3~5)을 유지해야 하는지, Step 1로 표시해야 하는지 결정이 필요합니다.
>
> - 옵션 A: StepIndicator를 현재 Step 유지하면서 리소스 선택 영역만 편집 모드로 전환
> - 옵션 B: StepIndicator를 Step 1로 표시하여 "처음부터 다시"임을 명시

---

### 2-3. X/O/X — 최초 승인 요청 중

처음으로 승인 요청을 보낸 상태. 확정 정보 없음.

```
┌─────────────────────────────────────────────────────────┐
│ Step 2. 승인 대기 중             ← StepIndicator 활성    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─ 📋 배너 (info) ─────────────────────────────────┐   │
│  │ 관리자 승인을 기다리고 있습니다.                    │   │
│  │ 요청일시: 2026-02-11 14:30 · 요청자: hong@corp    │   │
│  └──────────────────────────────────────────────────┘   │
│                                                         │
│  승인 요청된 리소스 (읽기 전용)                           │
│  ┌───────────────────────────────────────────────────┐  │
│  │ rds-prod-01    RDS    ap-northeast-2    TARGET     │  │
│  │ rds-prod-02    RDS    ap-northeast-2    TARGET     │  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
│  제외된 리소스: rds-dev-01 (사유: 개발 환경)              │
│                                                         │
│                     [승인 요청 취소]  ← 보조 액션 (위험)   │
└─────────────────────────────────────────────────────────┘
```

**인터랙션**:
- 요청된 리소스 목록은 읽기 전용
- "승인 요청 취소" 클릭 → 확인 모달 → `POST /cancel-approval-request` → X/X/X로 복귀

---

### 2-4. O/O/X — 변경 요청 중

기존 연동이 있는 상태에서 변경 요청을 보낸 상태.

```
┌─────────────────────────────────────────────────────────┐
│ Step 2. 승인 대기 중             ← StepIndicator 활성    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─ 📋 배너 (info) ─────────────────────────────────┐   │
│  │ 변경 요청에 대한 관리자 승인을 기다리고 있습니다.    │   │
│  │ 요청일시: 2026-02-11 14:30 · 요청자: hong@corp    │   │
│  └──────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─ 뷰 전환 ────────────────────────────────────────┐   │
│  │  [● 변경 요청 정보]    [○ 현재 연동 정보]          │   │
│  └──────────────────────────────────────────────────┘   │
│                                                         │
│  --- "변경 요청 정보" 선택 시 ---                         │
│  승인 요청된 리소스 (읽기 전용)                           │
│  ┌───────────────────────────────────────────────────┐  │
│  │ rds-prod-01    RDS    ap-northeast-2    유지       │  │
│  │ rds-prod-02    RDS    ap-northeast-2    유지       │  │
│  │ rds-staging    RDS    ap-northeast-2    추가       │  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
│  --- "현재 연동 정보" 선택 시 ---                         │
│  현재 연동된 리소스 (읽기 전용)                           │
│  ┌───────────────────────────────────────────────────┐  │
│  │ rds-prod-01    RDS    ap-northeast-2    연결됨 ●   │  │
│  │ rds-prod-02    RDS    ap-northeast-2    연결됨 ●   │  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
│                     [승인 요청 취소]  ← 보조 액션 (위험)   │
└─────────────────────────────────────────────────────────┘
```

**인터랙션**:
- 뷰 전환으로 요청 정보 ↔ 현재 연동 정보를 왔다 갔다 할 수 있음
- 요청 정보에서는 기존 대비 변경사항(추가/제거)을 시각적으로 구분
- "승인 요청 취소" 클릭 → 확인 모달 → O/X/X로 복귀

> **[결정 포인트 DP-02]** 변경 요청 시 diff 표시 여부
>
> 변경 요청 정보에서 기존 연동 대비 추가/제거된 리소스를 시각적으로 구분(예: 추가=파란색 뱃지, 제거=빨간색 뱃지)할지,
> 단순히 요청된 리소스 목록만 보여줄지 결정이 필요합니다.
>
> - 옵션 A: diff 표시 (추가/제거/유지 뱃지) — 변경 내용 파악 용이
> - 옵션 B: 요청 목록만 표시 — 구현 단순, 현재 연동 정보는 뷰 전환으로 확인

---

### 2-5. X/X/O — 최초 반영 중

승인 완료 후 Terraform 반영이 진행 중인 상태. 이전 확정 정보 없음.

```
┌─────────────────────────────────────────────────────────┐
│ Step 3. 설치 중                  ← StepIndicator 활성    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─ 🔄 배너 (warning) ──────────────────────────────┐   │
│  │ 승인된 연동 정보를 반영하고 있습니다.               │   │
│  │ 승인일시: 2026-02-11 15:00                        │   │
│  │                                                   │   │
│  │  ■■■■■■■■■■░░░░░░░░░░  2/3 완료                   │   │
│  │  [▾ 상세 보기]                                     │   │
│  │  ┌──────────────────────────────────────────┐     │   │
│  │  │ ✅ 입력 반영 완료                          │     │   │
│  │  │ ✅ 서비스 TF 설치 완료                     │     │   │
│  │  │ ⏳ BDC TF 설치 진행 중                     │     │   │
│  │  └──────────────────────────────────────────┘     │   │
│  └──────────────────────────────────────────────────┘   │
│                                                         │
│  반영 중인 리소스 (읽기 전용)                             │
│  ┌───────────────────────────────────────────────────┐  │
│  │ rds-prod-01    RDS    ap-northeast-2              │  │
│  │ rds-prod-02    RDS    ap-northeast-2              │  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
│  ※ 반영이 완료될 때까지 새로운 승인 요청을 할 수 없습니다. │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**인터랙션**:
- 모든 액션 버튼 비활성화 (반영 중에는 변경 불가)
- Black Box 진행 지표: 기본은 프로그레스 바, "상세 보기"로 3개 지표 확인 가능
- ApprovedIntegration의 resource_infos를 목록으로 표시
- 반영 완료 시 자동으로 O/X/X 상태로 전환

---

### 2-6. O/X/O — 기존 유지 + 반영 중

기존 연동이 있고, 변경 건의 승인이 반영 중인 상태.

```
┌─────────────────────────────────────────────────────────┐
│ Step 3. 설치 중                  ← StepIndicator 활성    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─ 🔄 배너 (warning) ──────────────────────────────┐   │
│  │ 변경된 연동 정보를 반영하고 있습니다.               │   │
│  │ 승인일시: 2026-02-11 15:00                        │   │
│  │                                                   │   │
│  │  ■■■■■■■■■■░░░░░░░░░░  2/3 완료                   │   │
│  │  [▾ 상세 보기]                                     │   │
│  └──────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─ 뷰 전환 ────────────────────────────────────────┐   │
│  │  [● 반영 중인 정보]    [○ 이전 연동 정보]          │   │
│  └──────────────────────────────────────────────────┘   │
│                                                         │
│  --- "반영 중인 정보" 선택 시 ---                         │
│  반영 중인 리소스 (읽기 전용)                             │
│  ┌───────────────────────────────────────────────────┐  │
│  │ rds-prod-01    RDS    ap-northeast-2              │  │
│  │ rds-prod-02    RDS    ap-northeast-2              │  │
│  │ rds-staging    RDS    ap-northeast-2              │  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
│  --- "이전 연동 정보" 선택 시 ---                         │
│  이전 연동된 리소스 (읽기 전용)                           │
│  ┌───────────────────────────────────────────────────┐  │
│  │ rds-prod-01    RDS    ap-northeast-2    연결됨 ●   │  │
│  │ rds-prod-02    RDS    ap-northeast-2    연결됨 ●   │  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
│  ※ 반영이 완료될 때까지 새로운 승인 요청을 할 수 없습니다. │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**인터랙션**:
- 뷰 전환으로 반영 중 정보 ↔ 이전 연동 정보 확인 가능
- 모든 액션 버튼 비활성화
- 반영 완료 시 이전 확정 정보가 새 확정 정보로 교체되고 O/X/X로 전환

---

## 3. 관리자 승인/반려 화면

승인 대기 상태(X/O/X 또는 O/O/X)에서 관리자에게만 보이는 액션.

```
┌─────────────────────────────────────────────────────────┐
│ (관리자 전용 액션 영역)                                   │
│                                                         │
│  ┌─ 승인 요청 상세 ─────────────────────────────────┐   │
│  │ 요청자: hong@corp                                │   │
│  │ 요청일시: 2026-02-11 14:30                       │   │
│  │ 대상 리소스: 3개                                  │   │
│  │ 제외 리소스: 1개 (사유: 개발 환경)                 │   │
│  └──────────────────────────────────────────────────┘   │
│                                                         │
│              [반려]  ← 보조(위험)    [승인]  ← 기본 액션  │
└─────────────────────────────────────────────────────────┘
```

**승인 모달**:
```
┌──────────────────────────────────┐
│ 승인 확인                        │
│                                  │
│ 3개 리소스에 대한 연동을 승인     │
│ 하시겠습니까?                    │
│                                  │
│ 코멘트 (선택):                   │
│ ┌──────────────────────────┐    │
│ │                          │    │
│ └──────────────────────────┘    │
│                                  │
│          [취소]    [승인]         │
└──────────────────────────────────┘
```

**반려 모달**:
```
┌──────────────────────────────────┐
│ 반려                             │
│                                  │
│ 반려 사유 (필수):                │
│ ┌──────────────────────────┐    │
│ │                          │    │
│ └──────────────────────────┘    │
│                                  │
│          [취소]    [반려]         │
└──────────────────────────────────┘
```

> **[결정 포인트 DP-03]** 관리자 승인 UI 위치
>
> 관리자가 승인/반려 액션을 수행하는 위치를 결정해야 합니다.
>
> - 옵션 A: 프로젝트 상세 페이지 내 리소스 영역에 권한에 따라 "승인/반려" 버튼 조건부 렌더링
> - 옵션 B: 관리자 대시보드에 별도 "승인 대기 목록" 추가 → 해당 프로젝트로 이동하여 처리
> - 옵션 C: A + B 모두 (대시보드에서 확인, 프로젝트에서 처리)

---

## 4. StepIndicator 연동

기존 5단계 프로세스에서의 Step 매핑:

| 상태 | Calculator 반환값 | StepIndicator |
|------|-------------------|---------------|
| X/X/X (최초 진입) | WAITING_TARGET_CONFIRMATION | Step 1 활성 |
| O/X/X (연동 완료) | INSTALLING ~ COMPLETED | Step 3~5 활성 |
| X/O/X (최초 요청 중) | WAITING_APPROVAL | Step 2 활성 |
| O/O/X (변경 요청 중) | WAITING_APPROVAL | Step 2 활성 |
| X/X/O (최초 반영 중) | INSTALLING | Step 3 활성 |
| O/X/O (반영 중) | INSTALLING | Step 3 활성 |

> **[결정 포인트 DP-04]** 변경 요청 시(O/O/X) StepIndicator 표시
>
> 기존에 Step 5(완료)까지 진행된 프로젝트가 변경 요청을 하면, StepIndicator가 Step 2로 돌아갑니다.
> 이때 Step 3~5가 "이전에 완료됨"인지 "아직 안 됨"인지 시각적으로 구분할지 결정이 필요합니다.
>
> - 옵션 A: 단순히 Step 2 활성 (기존 진행 정보 표시 없음) — 구현 단순
> - 옵션 B: Step 1 완료 + Step 2 활성 + Step 3~5 "재처리 대기" 표시 — 맥락 제공

---

## 5. 승인 요청 플로우 상세

### 5-1. 리소스 선택 → 승인 요청

```
사용자가 리소스 선택
    ↓
TARGET 리소스 중 미선택 항목 존재?
    ├─ Yes → 제외 사유 입력 필드 노출
    └─ No  → 바로 승인 요청 가능
    ↓
"승인 요청" 버튼 클릭
    ↓
POST /confirm-targets
  { target_resource_ids, excluded_resource_ids?, exclusion_reason?, vm_configs? }
    ↓
백엔드 내부:
  - ApprovalRequest 생성
  - AutoApprovalPolicy 평가
    ├─ 자동 승인 → ApprovalResult(APPROVED) + ApprovedIntegration 즉시 생성
    └─ 수동 승인 필요 → PENDING 상태 유지
    ↓
프론트엔드: 응답의 approval_request 확인
  - GET /approved-integration 폴링 시작
  - 상태에 따라 화면 전환
```

> **[결정 포인트 DP-05]** 승인 요청 전 확인 단계
>
> "승인 요청" 버튼 클릭 시 바로 API를 호출할지, 확인 모달을 보여줄지 결정이 필요합니다.
>
> - 옵션 A: 확인 모달 표시 (선택한 리소스 요약 + "승인 요청하시겠습니까?")
> - 옵션 B: 바로 API 호출 (취소 기능이 있으므로 확인 불필요)

### 5-2. 자동 승인과 사용자 경험

자동 승인은 백엔드 내부 로직이므로 프론트엔드는 이를 구분하지 않는다.

```
사용자 관점:
  "승인 요청" 클릭 → (짧은 로딩) → "반영 중" 화면으로 전환

  자동 승인 조건 충족 시 승인 대기 화면을 거치지 않고 바로 반영 중으로 넘어간다.
  사용자는 "빨리 승인되었네" 정도로 인식.
```

> **[결정 포인트 DP-06]** 자동 승인 시 전환 UX
>
> 자동 승인이 되면 승인 대기(Step 2)를 건너뛰고 바로 반영 중(Step 3)으로 전환됩니다.
> 이 전환을 어떻게 보여줄지 결정이 필요합니다.
>
> - 옵션 A: 별도 안내 없이 바로 반영 중 화면 표시
> - 옵션 B: "자동 승인되어 반영을 시작합니다" 토스트 메시지 표시 후 전환

---

## 6. 에러/예외 상태 처리

### 6-1. 반려 후

- 반려 시 X/X/X 또는 O/X/X로 복귀
- 해당 화면에 반려 사유 배너 추가 표시
- 배너는 사용자가 닫거나, 새 승인 요청을 하면 자동 소멸

### 6-2. 시스템 에러 후

- 반영 중 실패 시 X/X/X 또는 O/X/X로 복귀
- 에러 안내 배너 표시
- 패턴은 반려와 동일

### 6-3. 취소

- 사용자가 직접 승인 요청을 취소
- X/X/X 또는 O/X/X로 복귀
- 별도 배너 없음 (사용자 본인의 의도적 행동)

---

## 7. 데이터 흐름과 폴링

프론트엔드가 상태를 판단하기 위해 조회하는 API:

```
페이지 로드 시:
  1. GET /approved-integration     → null이 아니면 "반영 중"
  2. GET /approval-history?limit=1 → 마지막 request/result 확인
  3. 기존 project status 조회      → targets.confirmed 등

반영 중 상태(X/X/O, O/X/O)에서:
  - Black Box 지표 폴링 (Infra Manager 설치 상태 API)
  - 반영 완료 감지 시 approved-integration 재조회 → null이면 완료
```

> **[결정 포인트 DP-07]** 반영 중 폴링 주기
>
> Black Box 진행 지표와 반영 완료 여부를 확인하는 폴링 주기를 결정해야 합니다.
>
> - 옵션 A: 10초 간격 폴링
> - 옵션 B: 30초 간격 폴링
> - 옵션 C: 점진적 백오프 (처음 10초 → 최대 60초)

---

## 8. 결정 포인트 요약

| ID | 주제 | 옵션 | 비고 |
|----|------|------|------|
| DP-01 | "연동 대상 변경" 시 StepIndicator 표시 | A: 현재 Step 유지 / B: Step 1 표시 | 섹션 2-2 |
| DP-02 | 변경 요청 시 diff 표시 | A: diff 뱃지 / B: 목록만 | 섹션 2-4 |
| DP-03 | 관리자 승인 UI 위치 | A: 프로젝트 내 / B: 대시보드 / C: 둘 다 | 섹션 3 |
| DP-04 | 변경 요청 시 StepIndicator 이전 완료 표시 | A: 단순 / B: 재처리 대기 표시 | 섹션 4 |
| DP-05 | 승인 요청 전 확인 모달 | A: 확인 모달 / B: 바로 호출 | 섹션 5-1 |
| DP-06 | 자동 승인 시 전환 UX | A: 바로 전환 / B: 토스트 후 전환 | 섹션 5-2 |
| DP-07 | 반영 중 폴링 주기 | A: 10초 / B: 30초 / C: 점진적 백오프 | 섹션 7 |
