# PR #199 — 승인 프로세스 UX 구현 요약

> 브랜치: `feat/approval-process-alignment`
> ADR-006 기반 3-Object 모델 (ConfirmedIntegration / ApprovalRequest / ApprovedIntegration)

## 변경 규모

| 항목 | 수치 |
|------|------|
| 커밋 | 7개 (기능 3 + 리뷰 수정 4) |
| 신규 파일 | 6개 |
| 수정 파일 | 18개 |
| 변경량 | +1,136 / -1,369 줄 |

## 구현 시나리오

| 구분 | 시나리오 | 상태 전환 |
|------|---------|----------|
| PR 1 | A2 최초 승인 대기, A3 반영 중, A7 취소, A9 반려 | 최초 요청 흐름 |
| PR 2 | A5 변경 요청, A6 변경 대기, A8 변경 취소, A10 변경 반려 | 변경 요청 흐름 |

### 상태 표기법

3-Object 존재 여부를 `O/X` 순서로 표기: **Confirmed / Request / Approved**

- `X/O/X` = 확정 없음 / 요청 있음 / 반영 없음 → 최초 승인 대기
- `O/O/X` = 확정 있음 / 요청 있음 / 반영 없음 → 변경 승인 대기

---

## 시나리오별 사용자 화면

### A2. 최초 승인 대기 (X/O/X)

**진입**: 리소스를 처음 선택 → 승인 요청 제출

| 요소 | 내용 |
|------|------|
| 컴포넌트 | `ApprovalWaitingCard` |
| 배경 | 파란색 info 카드 |
| 아이콘 | 시계 |
| 제목 | **"관리자 승인을 기다리고 있습니다"** |
| 부제 | "승인이 완료되면 자동으로 연동이 시작됩니다." |
| CTA 1 | `요청 내용 확인` → 모달: 요청일시, 요청자, 포함/제외 리소스 테이블 |
| CTA 2 | `요청 취소` → 취소 확인 모달 |
| 자동 감지 | 10초 폴링 → 승인되면 A3로 자동 전환 |

---

### A3. 최초 반영 중 (X/X/O)

**진입**: 관리자가 승인 → 폴링이 감지 → 자동 전환

| 요소 | 내용 |
|------|------|
| 컴포넌트 | `ApprovalApplyingBanner` |
| 배경 | 파란색 info 배너 |
| 아이콘 | 체크마크 |
| 제목 | **"승인이 완료되어 연동을 반영하고 있습니다"** |
| 부제 | "반영은 최대 하루 소요될 수 있습니다. 완료 시 알림을 보내드립니다." |
| CTA | 없음 (정보성 배너) |
| 하단 | 클라우드별 설치 인라인 (AWS/Azure/GCP) |
| 자동 감지 | 10초 폴링 → 반영 완료 시 연결 테스트 단계로 전환 |

---

### A5. 변경 요청 제출 (O/X/X → O/O/X)

**진입**: 설치 완료 상태에서 "확정 대상 수정" → 리소스 재선택 → 승인 요청

| 요소 | 내용 |
|------|------|
| 진입 | 설치 완료(O/X/X) 상태에서 편집 모드 활성화 |
| 모달 | `ApprovalRequestModal`: 포함/제외 리소스 확인 + 제외 사유 입력 |
| 제출 후 | 상태 → WAITING_APPROVAL(O/O/X) → A6 화면으로 전환 |

---

### A6. 변경 승인 대기 (O/O/X)

**진입**: 변경 요청 제출 후 도달. A2와 동일한 카드 + 기존 확정 정보 추가 표시.

| 요소 | 내용 |
|------|------|
| 컴포넌트 | `ApprovalWaitingCard` + `ConfirmedIntegrationCollapse` |
| 메인 UI | A2와 동일 ("관리자 승인을 기다리고 있습니다") |
| **추가** | **"현재 연동 정보 보기"** 접이식 섹션 |
| 접이식 내용 | 기존 확정 리소스 테이블 (리소스 ID, 유형, Credential) |
| 의미 | 사용자가 현재 연동 상태와 변경 요청 내용을 비교 가능 |
| CTA 1 | `요청 내용 확인` (새 변경 요청 내용) |
| CTA 2 | `요청 취소` (변경 요청 취소 → O/X/X로 복원) |

---

### A6'. 변경 반영 중 (O/X/O)

**진입**: 변경 요청이 승인됨 → 새 설정 반영 중

| 요소 | 내용 |
|------|------|
| 컴포넌트 | `ApprovalApplyingBanner` + `ConfirmedIntegrationCollapse` |
| 메인 UI | A3와 동일 ("승인이 완료되어 연동을 반영하고 있습니다") |
| **추가** | **"이전 연동 정보 보기"** 접이식 섹션 |
| 접이식 내용 | 이전 확정 리소스 테이블 |
| 의미 | 변경 전 상태 참조용 (롤백 판단 근거) |

---

### A7. 최초 요청 취소 (X/O/X → X/X/X)

**진입**: 승인 대기 중 사용자가 "요청 취소" 클릭

| 요소 | 내용 |
|------|------|
| 컴포넌트 | `CancelApprovalModal` |
| 아이콘 | 경고 삼각형 (주황색) |
| 제목 | **"승인 요청 취소"** |
| 본문 | "승인 요청을 취소하시겠습니까?" |
| 부제 | "취소 후 리소스를 다시 선택하여 재요청할 수 있습니다." |
| CTA 1 | `닫기` (Secondary) |
| CTA 2 | `요청 취소` (Danger, 로딩 시 "취소 중...") |
| 취소 후 | 리소스 선택 단계(REQUEST_REQUIRED)로 복귀 |

---

### A8. 변경 요청 취소 (O/O/X → O/X/X)

**진입**: 변경 승인 대기 중 사용자가 "요청 취소" 클릭

| 요소 | 내용 |
|------|------|
| 컴포넌트 | `CancelApprovalModal` (A7과 동일 모달) |
| 취소 후 | 이전 확정 상태(INSTALLATION_COMPLETE)로 **복원** — 기존 연동 유지 |
| A7과 차이 | A7은 초기 상태로 복귀, A8은 이전 확정 상태로 복원 |

---

### A9. 최초 요청 반려 (X/O/X → X/X/X + rejected)

**진입**: 관리자가 반려 → 폴링이 감지 → 자동 전환

| 요소 | 내용 |
|------|------|
| 컴포넌트 | `RejectionAlert` |
| 배경 | 빨간색 error 카드 |
| 아이콘 | 경고 삼각형 (빨간색) |
| 제목 | **"승인 요청이 반려되었습니다"** |
| 사유 | "사유: {rejectionReason}" (있을 때만 표시) |
| 일시 | "반려일시: 2026-02-19 14:30:00" |
| CTA | `리소스 다시 선택하기` → 리소스 선택 단계로 이동 |

---

### A10. 변경 요청 반려 (O/O/X → O/X/X + rejected)

**진입**: 관리자가 변경 요청을 반려

| 요소 | 내용 |
|------|------|
| 컴포넌트 | `RejectionAlert` (A9와 동일 UI) |
| 차이점 | 변경 요청이 폐기되고 이전 확정 상태로 복귀 가능 |
| CTA | `리소스 다시 선택하기` → 이전 확정 리소스가 선택 초기값 |

---

## 상태 전환 흐름도

```
[리소스 선택] ──제출──→ A2 승인 대기 ──승인──→ A3 반영 중 ──완료──→ [설치 완료]
                            │                                           │
                         A7 취소                                     A5 변경 요청
                            │                                           │
                            v                                           v
                      [리소스 선택]                              A6 변경 대기 ──승인──→ A6' 변경 반영 중
                                                                    │                        │
                                                               A8 취소  A10 반려         [설치 완료]
                                                                    │       │
                                                                    v       v
                                                              [설치 완료] [반려 알림]
                            ^                                               │
                            └─── A9 반려 ←──────────────────────────────────┘
```

---

## 핵심 설계 포인트

### 1. 단일 플래그로 최초/변경 구분

`hasConfirmedIntegration` (BFF `status_inputs.has_confirmed_integration`)만으로 A2/A6, A3/A6' 구분.
별도의 상태 변수나 플래그 추가 없이 기존 BFF API 활용.

### 2. 접이식 컴포넌트 재사용

`ConfirmedIntegrationCollapse` 하나로 두 시나리오 대응:
- A6 (O/O/X): label = "현재 연동 정보 보기"
- A6' (O/X/O): label = "이전 연동 정보 보기"

Lazy fetch — 펼칠 때만 `getConfirmedIntegration()` 호출.

### 3. 폴링 기반 자동 전환

ProcessStatusCard에서 10초 간격으로 `getProcessStatus()` 호출:
- 승인 → 반영 중 자동 전환 (A2→A3, A6→A6')
- 반려 → 반려 알림 자동 전환 (A9, A10)
- 반영 완료 → 연결 테스트 단계 자동 전환

### 4. 취소 후 복원 로직 분기

| 시나리오 | 취소 후 상태 | 복원 동작 |
|---------|------------|----------|
| A7 (최초) | X/X/X | 리소스 선택 해제 → REQUEST_REQUIRED |
| A8 (변경) | O/X/X | 이전 확정 복원 → INSTALLATION_COMPLETE |

---

## 신규 컴포넌트

| 파일 | 용도 | 줄 수 |
|------|------|-------|
| `process-status/ApprovalWaitingCard.tsx` | 승인 대기 카드 (A2/A6) | 104 |
| `process-status/ApprovalApplyingBanner.tsx` | 반영 중 배너 (A3/A6') | 42 |
| `process-status/ApprovalRequestDetailModal.tsx` | 요청 상세 모달 | 108 |
| `process-status/CancelApprovalModal.tsx` | 취소 확인 모달 | 71 |
| `process-status/ConfirmedIntegrationCollapse.tsx` | 확정 정보 접이식 | 88 |
| `common/RejectionAlert.tsx` | 반려 알림 (A9/A10) | ~20 |

## 수정 컴포넌트

| 파일 | 변경 내용 |
|------|----------|
| `ProcessStatusCard.tsx` | 폴링에 `hasConfirmedIntegration` 추가, 승인 컴포넌트 렌더링 분기 |
| `AwsProjectPage.tsx` | 승인 모달 props 연결 |
| `AzureProjectPage.tsx` | 승인 모달 props 연결 |
| `GcpProjectPage.tsx` | 승인 모달 props 연결 |
| `app/lib/api/index.ts` | 승인 관련 API 함수 추가 |
